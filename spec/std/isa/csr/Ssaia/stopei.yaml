# Copyright (c) 2025 Kallal Mukherjee
# SPDX-License-Identifier: BSD-3-Clause-Clear

# yaml-language-server: $schema=../../../schemas/csr_schema.json

$schema: "csr_schema.json#"
kind: csr
name: stopei
long_name: Supervisor Top External Interrupt Pending
address: 0x15C
priv_mode: S
length: MXLEN
writable: false
description: |
  Holds the interrupt ID of the highest-priority pending interrupt observed by the
  IMSIC interrupt file that is not disabled by the corresponding bits in sie.

  When no interrupt is pending, the register reads 0. When an interrupt is pending,
  the register holds the interrupt ID in the Interrupt ID (IID) field.

  This register is read-only and is automatically updated by the hardware.
definedBy: Ssaia
fields:
  IID:
    location_rv32: 31-16
    location_rv64: 63-16
    long_name: Interrupt ID
    description: |
      Interrupt ID of the highest-priority pending interrupt.

      The IID field holds the interrupt ID of the highest-priority pending interrupt
      observed by the IMSIC interrupt file that is not disabled by the corresponding
      bits in sie.
    type: RO
    reset_value: 0
    definedBy: Ssaia
  IP:
    location: 15-0
    long_name: Interrupt Priority
    description: |
      Priority of the highest-priority pending interrupt.

      The IP field holds the priority of the highest-priority pending interrupt
      observed by the IMSIC interrupt file that is not disabled by the corresponding
      bits in sie.
    type: RO
    reset_value: 0
    definedBy: Ssaia
sw_read(): |
  // Return the top pending external interrupt
  if (!implemented?(ExtensionName::Ssaia)) {
    return 0;
  }
  
  // Get the highest priority pending interrupt from IMSIC
  TopInterrupt top = get_top_imsic_interrupt(PrivilegeMode::S);
  return (top.id << 16) | top.priority;
sw_write(csr_value): |
  // This register is read-only, writes are ignored
  return csr_value;